<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - ISS Viáticos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- script del tema -->
    <script>
      (function() {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
          document.documentElement.classList.add('dark');
        }
      })();
    </script>
    <!-- estilos del tema -->
    <th:block th:replace="~{fragments/theme :: themeStyles}"></th:block>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: [
                "-apple-system",
                "BlinkMacSystemFont",
                "SF Pro Display",
                "SF Pro Text",
                "Helvetica Neue",
                "sans-serif",
              ],
            },
            colors: {
              apple: {
                blue: "#007aff",
                gray: "#86868b",
                bg: "#ffffff",
                section: "#f5f5f7",
              },
            },
          },
        },
      };
    </script>
    <style>
      body {
        background-color: #ffffff;
        color: #1d1d1f;
        -webkit-font-smoothing: antialiased;
      }
      .dark body {
        background-color: #000000;
        color: #f5f5f7;
      }
      .glass-nav {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: saturate(180%) blur(20px);
        -webkit-backdrop-filter: saturate(180%) blur(20px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      }
      .dark .glass-nav {
        background: rgba(28, 28, 30, 0.85);
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }
      .stat-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
      }
      .dot-orange {
        background-color: #ff9500;
      }
      .dot-green {
        background-color: #34c759;
      }
      .dot-blue {
        background-color: #007aff;
      }
      .dot-red {
        background-color: #ff3b30;
      }

      .ios-list-item {
        transition: background-color 0.2s ease;
        border-bottom: 1px solid #f5f5f7;
      }
      .dark .ios-list-item {
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      .ios-list-item:hover {
        background-color: #fafafa;
      }
      .dark .ios-list-item:hover {
        background-color: rgba(255, 255, 255, 0.03);
      }
      .ios-list-item:last-child {
        border-bottom: none;
      }

      .action-pill {
        background: #f5f5f7;
        border-radius: 980px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .dark .action-pill {
        background: #2c2c2e;
      }
      .action-pill:hover {
        background: #e8e8ed;
        transform: scale(1.02);
      }
      .dark .action-pill:hover {
        background: #3a3a3c;
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col">
    <!-- barra de navegación -->
    <nav class="fixed top-0 w-full z-50 glass-nav h-12">
      <div
        class="max-w-6xl mx-auto px-8 h-full flex items-center justify-between"
      >
        <div class="flex items-center gap-8">
          <a href="/" class="text-[15px] font-bold tracking-tight text-gray-900 dark:text-white"
            >ISS Viáticos</a
          >
          <div
            class="hidden md:flex items-center gap-6 text-[13px] font-medium text-apple-gray"
          >
            <a
              href="/solicitudes"
              class="hover:text-apple-blue transition-colors"
              >Solicitudes</a
            >
            <a
              th:if="${isAdmin}"
              href="/admin/aprobaciones"
              class="hover:text-apple-blue transition-colors"
              >Aprobaciones</a
            >
            <a
              th:if="${isAdmin}"
              href="/admin/validaciones"
              class="hover:text-apple-blue transition-colors"
              >Validaciones</a
            >
            <a
              th:if="${isAdmin}"
              href="/admin/empleados"
              class="hover:text-apple-blue transition-colors"
              >Personal</a
            >
            <a
              th:if="${isAdmin}"
              href="/admin/tarifarios"
              class="hover:text-apple-blue transition-colors"
              >Configuración</a
            >
          </div>
        </div>

        <div class="flex items-center gap-4" th:if="${currentUser != null}">
          <!-- botton de togle -->
          <button 
            id="themeToggle"
            onclick="toggleTheme()"
            class="w-8 h-8 rounded-lg flex items-center justify-center transition-all hover:bg-gray-100 dark:hover:bg-white/10"
            title="Cambiar tema"
          >
            <i data-lucide="sun" class="w-4 h-4 text-gray-500 hidden dark:block dark:text-yellow-400"></i>
            <i data-lucide="moon" class="w-4 h-4 text-gray-500 block dark:hidden"></i>
          </button>
          <span class="w-[1px] h-3 bg-gray-200 dark:bg-gray-700"></span>
          <span
            class="text-[12px] font-medium text-gray-500 dark:text-gray-400"
            th:text="${currentUser.nombreCompleto}"
            >User</span
          >
          <span class="w-[1px] h-3 bg-gray-200 dark:bg-gray-700 "></span>
          <form th:action="@{/logout}" method="post" class="flex items-center">
            <button
              type="submit"
              class="text-[12px] font-medium text-apple-blue hover:underline"
            >
              Salir
            </button>
          </form>
        </div>
      </div>
    </nav>

    <main class="pt-24 px-8 pb-32">
      <div class="max-w-6xl mx-auto">
      <!-- Header -->
      <header class="mb-16">
        <h1 class="text-4xl font-bold tracking-tight mb-2 text-gray-900 dark:text-white">Resumen</h1>
        <p class="text-xl text-apple-gray font-medium">
          Control general de operaciones y viáticos.
        </p>
      </header>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-12 mb-20">
        <!-- estadísticas -->
        <div class="flex flex-col gap-2">
          <div class="flex items-center gap-2">
            <div class="stat-dot dot-orange"></div>
            <span
              class="text-[11px] font-bold uppercase tracking-[0.15em] text-apple-gray"
              >Pendientes</span
            >
          </div>
          <span
            class="text-5xl font-bold tracking-tighter text-gray-900 dark:text-white"
            th:text="${totalPendientes}"
            >0</span
          >
        </div>
        <div class="flex flex-col gap-2">
          <div class="flex items-center gap-2">
            <div class="stat-dot dot-green"></div>
            <span
              class="text-[11px] font-bold uppercase tracking-[0.15em] text-apple-gray"
              >Aprobadas</span
            >
          </div>
          <span
            class="text-5xl font-bold tracking-tighter text-gray-900 dark:text-white"
            th:text="${totalAprobados}"
            >0</span
          >
        </div>
        <div class="flex flex-col gap-2">
          <div class="flex items-center gap-2">
            <div class="stat-dot dot-blue"></div>
            <span
              class="text-[11px] font-bold uppercase tracking-[0.15em] text-apple-gray"
              >Liquidadas</span
            >
          </div>
          <span
            class="text-5xl font-bold tracking-tighter text-gray-900 dark:text-white"
            th:text="${totalLiquidados}"
            >0</span
          >
        </div>
        <div class="flex items-center">
          <a
            href="/solicitudes/nueva"
            class="flex items-center justify-center gap-2 px-6 py-3 bg-black text-white rounded-full text-[13px] font-bold hover:bg-gray-800 transition-all active:scale-95 shadow-lg"
          >
            <i data-lucide="plus" class="w-4 h-4"></i> Crear Solicitud
          </a>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-16">
        <div class="lg:col-span-8">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl font-bold tracking-tight text-gray-900 dark:text-white">
              Actividad Reciente
            </h2>
            <a
              th:href="${isAdmin ? '/admin/aprobaciones' : '/solicitudes'}"
              class="text-[13px] font-semibold text-apple-blue hover:underline"
              >Ver todo</a
            >
          </div>

          <div class="space-y-0">
            <div
              th:each="sol : ${solicitudes}"
              class="ios-list-item py-6 flex items-center justify-between cursor-pointer group"
              th:onclick="'window.location.href=\'/solicitudes/' + ${sol.id} + '\''"
            >
              <div class="flex items-center gap-5">
                <div
                  th:class="${'w-11 h-11 rounded-full flex items-center justify-center ' + 
                                            (sol.estado.name() == 'PENDIENTE' ? 'bg-orange-50 text-orange-500' : 
                                            (sol.estado.name() == 'APROBADO' ? 'bg-green-50 text-green-500' : 
                                            (sol.estado.name() == 'LIQUIDADO' ? 'bg-blue-50 text-blue-500' : 'bg-gray-50 text-gray-500')))}"
                >
                  <i
                    th:if="${sol.estado.name() == 'PENDIENTE'}"
                    data-lucide="clock"
                    class="w-5 h-5"
                  ></i>
                  <i
                    th:if="${sol.estado.name() == 'APROBADO'}"
                    data-lucide="check"
                    class="w-5 h-5"
                  ></i>
                  <i
                    th:if="${sol.estado.name() == 'LIQUIDADO'}"
                    data-lucide="shield"
                    class="w-5 h-5"
                  ></i>
                  <i
                    th:if="${sol.estado.name() == 'RECHAZADO'}"
                    data-lucide="x"
                    class="w-5 h-5"
                  ></i>
                </div>
                <div>
                  <h4
                    class="text-sm font-bold text-gray-900 dark:text-white group-hover:text-apple-blue transition-colors"
                    th:text="${sol.motivoViaje}"
                  >
                    Viaje
                  </h4>
                  <p
                    class="text-[13px] text-apple-gray font-medium"
                    th:text="${sol.fechaInicio + ' • ' + sol.empleado.nombres}"
                  >
                    Fecha
                  </p>
                </div>
              </div>
              <div class="text-right flex flex-col items-end">
                <span
                  class="text-sm font-bold tabular-nums text-gray-900 dark:text-white"
                  th:text="${'S/ ' + #numbers.formatDecimal(sol.montoTotal, 1, 0)}"
                  >0</span
                >
                <span
                  class="text-[10px] font-bold uppercase tracking-widest mt-1"
                  th:classappend="${sol.estado.name() == 'PENDIENTE' ? 'text-orange-500' : (sol.estado.name() == 'APROBADO' ? 'text-green-500' : 'text-apple-gray')}"
                  th:text="${sol.estado}"
                  >ESTADO</span
                >
              </div>
            </div>

            <div
              th:if="${#lists.isEmpty(solicitudes)}"
              class="py-20 text-center border-2 border-dashed border-gray-100 rounded-3xl"
            >
              <p class="text-apple-gray font-medium text-sm">
                No hay actividad reciente.
              </p>
            </div>
          </div>
        </div>

        <!-- columna derecha -->
        <div class="lg:col-span-4 space-y-12">
          <!-- gráfico -->
          <section>
            <h3
              class="text-xs font-bold uppercase tracking-[0.2em] text-apple-gray mb-8"
            >
              Estado de Flujo
            </h3>
            <div class="h-44 w-full">
              <canvas id="statusChart"></canvas>
            </div>
          </section>

          <!-- enlaces -->
          <section>
            <h3
              class="text-xs font-bold uppercase tracking-[0.2em] text-apple-gray mb-6"
            >
              Accesos
            </h3>
            <div class="space-y-3">
              <a
                href="/politicas"
                class="action-pill p-4 px-6 flex items-center justify-between"
              >
                <div class="flex items-center gap-3">
                  <i
                    data-lucide="book-open"
                    class="w-4 h-4 text-apple-gray"
                  ></i>
                  <span class="text-[13px] font-bold text-gray-900 dark:text-white"
                    >Políticas de Viáticos</span
                  >
                </div>
                <i
                  data-lucide="chevron-right"
                  class="w-4 h-4 text-gray-300"
                ></i>
              </a>
              <a
                href="/solicitudes"
                class="action-pill flex items-center justify-between p-4 px-6"
              >
                <div class="flex items-center gap-3">
                  <i data-lucide="archive" class="w-4 h-4 text-apple-gray"></i>
                  <span class="text-[13px] font-bold text-gray-900 dark:text-white">Historial de Viajes</span>
                </div>
                <i
                  data-lucide="chevron-right"
                  class="w-4 h-4 text-gray-300"
                ></i>
              </a>
            </div>
          </section>
        </div>
      </div>
    </main>

    <footer class="mt-auto py-12 px-8 border-t border-gray-100">
      <div class="max-w-screen-xl mx-auto flex items-center justify-between">
        <p class="text-[11px] text-apple-gray font-medium leading-relaxed">
          © 2024 Ingeniería y Servicios del Sur S.A.C.<br />
          Seguridad y Auditoría Financiera Aplicada.
        </p>
        <div class="flex items-center gap-2">
          <span
            class="stat-dot bg-green-500 shadow-[0_0_8px_rgba(52,199,89,0.5)]"
          ></span>
          <span
            class="text-[10px] font-bold uppercase tracking-widest text-apple-gray"
            >Sistema Activo</span
          >
        </div>
      </div>
    </footer>

    <script th:inline="javascript">
      lucide.createIcons();

      document.addEventListener("DOMContentLoaded", function () {
        const ctx = document.getElementById("statusChart").getContext("2d");
        const labels = /*[[${chartLabels}]]*/ [];
        const data = /*[[${chartData}]]*/ [];

        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: ["#FF9500", "#34C759", "#FF3B30", "#007AFF"],
                borderWidth: 0,
                hoverOffset: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
                labels: {
                  usePointStyle: true,
                  pointStyle: "circle",
                  padding: 20,
                  boxWidth: 6,
                  font: { size: 11, weight: "500", family: "-apple-system" },
                  color: "#86868b",
                },
              },
              tooltip: { enabled: true },
            },
            cutout: "82%",
          },
        });
      });
    </script>
    
    <!-- Theme Toggle Script -->
    <th:block th:replace="~{fragments/theme :: themeScript}"></th:block>
  </body>
</html>
