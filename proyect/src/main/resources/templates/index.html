<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ISS Viáticos</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: [
                "-apple-system",
                "BlinkMacSystemFont",
                "SF Pro Text",
                "Segoe UI",
                "Roboto",
                "Helvetica Neue",
                "arial",
                "sans-serif",
              ],
            },
            colors: {
              ios: {
                bg: "#F2F2F7",
                card: "#FFFFFF",
                text: "#1C1C1E",
                secondary: "#8E8E93",
                blue: "#007AFF",
                green: "#34C759",
                red: "#FF3B30",
                orange: "#FF9500",
                divider: "rgba(60, 60, 67, 0.36)",
              },
            },
            boxShadow: {
              "ios-sm": "0 1px 2px rgba(0,0,0,0.04)",
              "ios-card": "0 4px 12px rgba(0,0,0,0.06)",
            },
          },
        },
      };
    </script>
    <style>
      body {
        background-color: #f2f2f7;
        color: #1c1c1e;
        -webkit-font-smoothing: antialiased;
      }
      .glass-nav {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: saturate(180%) blur(20px);
        -webkit-backdrop-filter: saturate(180%) blur(20px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      }
      .ios-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        border: 1px solid rgba(0, 0, 0, 0.02);
        transition: transform 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
      }
      .ios-card:active {
        transform: scale(0.99);
      }
      .btn-ios {
        background: #007aff;
        color: white;
        border-radius: 9999px;
        font-weight: 600;
        transition: all 0.2s ease;
      }
      .btn-ios:hover {
        background: #0071e3;
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
      }
    </style>
  </head>
  <body class="flex flex-col min-h-screen">
    <!-- Navbar   -->
    <nav class="fixed top-0 w-full z-50 glass-nav h-14">
      <div
        class="max-w-[1400px] mx-auto px-6 h-full flex items-center justify-between"
      >
        <div class="flex items-center gap-1">
          <i data-lucide="command" class="w-5 h-5 text-gray-900"></i>
          <span class="text-sm font-semibold tracking-tight text-gray-900 ml-2"
            >ISS Viáticos</span
          >
        </div>

        <div class="flex items-center gap-6">
          <!-- enlaces -->
          <div
            class="hidden md:flex items-center gap-6 text-[13px] font-medium text-gray-500"
          >
            <a href="/solicitudes" class="hover:text-black transition-colors"
              >Solicitudes</a
            >
            <a
              th:if="${isAdmin}"
              href="/admin/aprobaciones"
              class="hover:text-black transition-colors"
              >Aprobaciones</a
            >
            <a
              th:if="${isAdmin}"
              href="/admin/tarifarios"
              class="hover:text-black transition-colors"
              >Configuración</a
            >
          </div>

          <!-- perfil de usuario -->
          <div
            class="flex items-center gap-3 pl-4 border-l border-gray-200"
            th:if="${currentUser != null}"
          >
            <span
              class="text-[12px] font-medium text-gray-900"
              th:text="${currentUser.nombreCompleto}"
              >User</span
            >
            <form th:action="@{/logout}" method="post">
              <button
                type="submit"
                class="p-1.5 rounded-full bg-gray-200/50 hover:bg-gray-300/50 transition-colors"
              >
                <i data-lucide="log-out" class="w-3.5 h-3.5 text-gray-500"></i>
              </button>
            </form>
          </div>
        </div>
      </div>
    </nav>

    <main class="flex-grow pt-24 pb-12 px-6">
      <div th:replace="~{fragments/common :: toaster}"></div>

      <div class="max-w-[1400px] mx-auto">
        <!-- Welcome Header (Clean, NotebookLM style) -->
        <div class="mb-10 flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-semibold tracking-tight text-gray-900">
              Dashboard
            </h1>
            <p class="text-sm text-gray-500 mt-1">
              Resumen general de operaciones.
            </p>
          </div>
          <div class="flex gap-3">
            <a
              href="/solicitudes/nueva"
              class="flex items-center gap-2 px-4 py-2 bg-gray-900 text-white rounded-full text-xs font-semibold hover:bg-gray-800 transition-colors shadow-lg"
            >
              <i data-lucide="plus" class="w-3 h-3"></i> Nueva Solicitud
            </a>
          </div>
        </div>

        <!-- Grid Layout -->
        <div class="grid grid-cols-12 gap-6">
          <!-- BLOQUE IZQUIERDO: KPIs + Lista (NotebookLM uses columns heavily) -->
          <div class="col-span-12 lg:col-span-8 flex flex-col gap-6">
            <!-- KPIs Row -->
            <div class="grid grid-cols-3 gap-4">
              <div
                class="ios-card p-5 flex flex-col justify-between h-32 hover:shadow-md transition-shadow"
              >
                <div class="flex justify-between items-start">
                  <span
                    class="text-[11px] font-bold text-gray-400 uppercase tracking-wider"
                    >Pendientes</span
                  >
                  <div class="w-2 h-2 rounded-full bg-orange-400"></div>
                </div>
                <div>
                  <span
                    class="text-3xl font-semibold tracking-tight text-gray-900"
                    th:text="${totalPendientes}"
                    >0</span
                  >
                  <span class="text-xs text-gray-400 ml-1">solicitudes</span>
                </div>
              </div>
              <div
                class="ios-card p-5 flex flex-col justify-between h-32 hover:shadow-md transition-shadow"
              >
                <div class="flex justify-between items-start">
                  <span
                    class="text-[11px] font-bold text-gray-400 uppercase tracking-wider"
                    >Aprobadas</span
                  >
                  <div class="w-2 h-2 rounded-full bg-green-500"></div>
                </div>
                <div>
                  <span
                    class="text-3xl font-semibold tracking-tight text-gray-900"
                    th:text="${totalAprobados}"
                    >0</span
                  >
                  <span class="text-xs text-gray-400 ml-1">comisiones</span>
                </div>
              </div>
              <div
                class="ios-card p-5 flex flex-col justify-between h-32 hover:shadow-md transition-shadow"
              >
                <div class="flex justify-between items-start">
                  <span
                    class="text-[11px] font-bold text-gray-400 uppercase tracking-wider"
                    >Liquidadas</span
                  >
                  <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                </div>
                <div>
                  <span
                    class="text-3xl font-semibold tracking-tight text-gray-900"
                    th:text="${totalLiquidados}"
                    >0</span
                  >
                  <span class="text-xs text-gray-400 ml-1">cerradas</span>
                </div>
              </div>
            </div>

            <!-- actividad reciente -->
            <div
              class="ios-card bg-white overflow-hidden flex-grow min-h-[400px]"
            >
              <div
                class="px-6 py-4 border-b border-gray-100 flex justify-between items-center"
              >
                <h3 class="text-sm font-semibold text-gray-900">
                  Actividad Reciente
                </h3>
                <button
                  class="text-xs font-medium text-gray-400 hover:text-blue-500 transition-colors"
                >
                  Filtrar
                </button>
              </div>
              <div class="divide-y divide-gray-50">
                <!-- actividad reciente Loop -->
                <div
                  th:each="sol : ${solicitudes}"
                  class="px-6 py-4 flex items-center justify-between hover:bg-gray-50/50 transition-colors group cursor-pointer"
                  th:onclick="'window.location.href=\'/solicitudes/' + ${sol.id} + '\''"
                >
                  <div class="flex items-center gap-4">
                    <!-- Icon estado -->
                    <div
                      th:class="${'w-10 h-10 rounded-xl flex items-center justify-center shrink-0 ' + 
                                (sol.estado.name() == 'PENDIENTE' ? 'bg-orange-50 text-orange-500' : 
                                (sol.estado.name() == 'APROBADO' ? 'bg-green-50 text-green-500' : 
                                (sol.estado.name() == 'LIQUIDADO' ? 'bg-blue-50 text-blue-500' : 'bg-gray-50 text-gray-500')))}"
                    >
                      <i
                        th:if="${sol.estado.name() == 'PENDIENTE'}"
                        data-lucide="clock"
                        class="w-5 h-5"
                      ></i>
                      <i
                        th:if="${sol.estado.name() == 'APROBADO'}"
                        data-lucide="check"
                        class="w-5 h-5"
                      ></i>
                      <i
                        th:if="${sol.estado.name() == 'LIQUIDADO'}"
                        data-lucide="shield"
                        class="w-5 h-5"
                      ></i>
                      <i
                        th:if="${sol.estado.name() == 'RECHAZADO'}"
                        data-lucide="x"
                        class="w-5 h-5"
                      ></i>
                      <i
                        th:if="${sol.estado.name() == 'BORRADOR'}"
                        data-lucide="file"
                        class="w-5 h-5"
                      ></i>
                    </div>
                    <div>
                      <p
                        class="text-sm font-semibold text-gray-900"
                        th:text="${sol.motivoViaje}"
                      >
                        Viaje a Lima
                      </p>
                      <p
                        class="text-[11px] text-gray-400"
                        th:text="${sol.fechaInicio + ' • ' + sol.empleado.nombres}"
                      >
                        12 Oct • Juan Perez
                      </p>
                    </div>
                  </div>
                  <div class="text-right">
                    <p
                      class="text-sm font-semibold text-gray-900 tabular-nums"
                      th:text="${'S/ ' + #numbers.formatDecimal(sol.montoTotal, 1, 0)}"
                    >
                      S/ 200
                    </p>
                    <p
                      class="text-[10px] font-bold uppercase tracking-wider text-gray-400"
                      th:text="${sol.estado}"
                    >
                      PENDIENTE
                    </p>
                  </div>
                </div>
                <!-- contenido vacio -->
                <div
                  th:if="${#lists.isEmpty(solicitudes)}"
                  class="px-6 py-12 text-center"
                >
                  <p class="text-sm text-gray-400">
                    No hay actividad reciente para mostrar.
                  </p>
                  <a
                    href="/solicitudes/nueva"
                    class="text-xs font-semibold text-blue-500 mt-2 inline-block"
                    >Crear nueva solicitud</a
                  >
                </div>
              </div>
              <div
                class="bg-gray-50/50 p-3 text-center border-t border-gray-100 mt-auto"
              >
                <a
                  th:href="${isAdmin ? '/admin/aprobaciones' : '/solicitudes'}"
                  class="text-xs font-medium text-gray-500 hover:text-gray-900"
                  >Ver historial completo</a
                >
              </div>
            </div>
          </div>

          <!-- BLOQUE DERECHO -->
          <div class="col-span-12 lg:col-span-4 flex flex-col gap-6">
            <!-- grafico -->
            <div class="ios-card p-6 bg-white">
              <h3 class="text-sm font-semibold text-gray-900 mb-6">
                Distribución de Estados
              </h3>
              <div class="h-48 relative">
                <canvas id="statusChart"></canvas>
              </div>
            </div>

            <!-- insights -->
            <div
              class="ios-card p-6 bg-gray-900 text-white relative overflow-hidden"
            >
              <div class="relative z-10">
                <h3 class="text-sm font-semibold text-gray-200 mb-1">
                  Efectividad
                </h3>
                <div class="flex items-baseline gap-2 mb-4">
                  <span class="text-4xl font-bold">94%</span>
                  <span
                    class="text-xs text-green-400 font-medium flex items-center"
                    ><i data-lucide="arrow-up" class="w-3 h-3"></i> +2.5%</span
                  >
                </div>
                <p class="text-xs text-gray-400 leading-relaxed max-w-[90%]">
                  Tu tiempo promedio de liquidación es de
                  <span class="text-white font-semibold">2 días</span>, lo cual
                  es excelente comparado con el promedio de la empresa.
                </p>
              </div>
              <div
                class="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full -mr-10 -mt-10 blur-2xl"
              ></div>
            </div>

            <!-- menu rápido -->
            <div class="grid grid-cols-2 gap-4">
              <button
                onclick="window.location.href='/solicitudes'"
                class="ios-card p-4 hover:bg-gray-50 text-left group"
              >
                <i
                  data-lucide="files"
                  class="w-5 h-5 text-gray-400 mb-2 group-hover:text-blue-500 transition-colors"
                ></i>
                <span class="block text-xs font-semibold text-gray-900"
                  >Mis Solicitudes</span
                >
              </button>
              <button
                onclick="window.location.href='/politicas'"
                class="ios-card p-4 hover:bg-gray-50 text-left group"
              >
                <i
                  data-lucide="book"
                  class="w-5 h-5 text-gray-400 mb-2 group-hover:text-purple-500 transition-colors"
                ></i>
                <span class="block text-xs font-semibold text-gray-900"
                  >Políticas</span
                >
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer Simple -->
    <footer class="py-8 bg-white border-t border-gray-100 mt-auto">
      <div
        class="max-w-[1400px] mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-4"
      >
        <p class="text-[11px] text-gray-400 font-medium">
          © 2024 Ingeniería y Servicios del Sur.
        </p>
        <div class="flex gap-4">
          <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
          <span
            class="text-[10px] uppercase font-bold tracking-widest text-gray-300"
            >Sistema Operativo</span
          >
        </div>
      </div>
    </footer>

    <script th:inline="javascript">
      lucide.createIcons();

      document.addEventListener("DOMContentLoaded", function () {
        const ctx = document.getElementById("statusChart").getContext("2d");
        const labels = /*[[${chartLabels}]]*/ [];
        const data = /*[[${chartData}]]*/ [];

        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: ["#FB923C", "#34C759", "#FF3B30", "#007AFF"],
                borderWidth: 0,
                hoverOffset: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
                labels: {
                  usePointStyle: true,
                  boxWidth: 6,
                  font: { size: 10, family: "-apple-system" },
                },
              },
            },
            cutout: "84%",
          },
        });
      });
    </script>
  </body>
</html>
