<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Solicitud - ISS Viáticos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        apple: {
                            bg: "#f5f5f7",
                            card: "rgba(255, 255, 255, 0.72)",
                            text: "#1d1d1f",
                            secondary: "#86868b",
                            blue: "#0071e3",
                            border: "rgba(0, 0, 0, 0.1)",
                        }
                    }
                }
            }
        };
    </script>
    <style>
        body { background-color: #f5f5f7; color: #1d1d1f; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.72); backdrop-filter: saturate(180%) blur(20px); border-bottom: 1px solid rgba(0, 0, 0, 0.1); }
        .apple-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); }
    </style>
</head>
<body class="antialiased">
    <!-- Nav -->
    <nav class="fixed top-0 w-full z-50 glass">
        <div class="max-w-4xl mx-auto px-6 h-11 flex items-center justify-between">
            <a href="/" class="text-[12px] font-semibold tracking-tight opacity-90 hover:opacity-100 transition-opacity">ISS Viáticos</a>
            <div class="flex gap-6">
                <a href="/solicitudes" class="text-[12px] font-bold text-apple-blue">Regresar</a>
            </div>
        </div>
    </nav>

    <main class="pt-24 pb-20 px-6">
        <div class="max-w-4xl mx-auto">
            <!-- Header Detalle -->
            <div class="flex items-start justify-between mb-10">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <h1 class="text-4xl font-semibold tracking-tight text-apple-text" th:text="${'Solicitud #' + sol.id}">#000</h1>
                        <span th:if="${sol.estado.name() == 'BORRADOR'}" class="px-3 py-1 bg-gray-100 text-gray-500 rounded-full text-[10px] font-bold uppercase tracking-wider">Borrador</span>
                        <span th:if="${sol.estado.name() == 'PENDIENTE'}" class="px-3 py-1 bg-amber-50 text-amber-600 rounded-full text-[10px] font-bold uppercase tracking-wider">Pendiente</span>
                        <span th:if="${sol.estado.name() == 'APROBADO'}" class="px-3 py-1 bg-green-50 text-green-600 rounded-full text-[10px] font-bold uppercase tracking-wider">Aprobado</span>
                        <span th:if="${sol.estado.name() == 'RECHAZADO'}" class="px-3 py-1 bg-red-50 text-red-600 rounded-full text-[10px] font-bold uppercase tracking-wider">Rechazado</span>
                        <span th:if="${sol.estado.name() == 'RENDIDO'}" class="px-3 py-1 bg-blue-50 text-blue-600 rounded-full text-[10px] font-bold uppercase tracking-wider">Rendido</span>
                        <span th:if="${sol.estado.name() == 'LIQUIDADO'}" class="px-3 py-1 bg-green-500 text-white rounded-full text-[10px] font-bold uppercase tracking-wider">Liquidado</span>
                        <span th:if="${sol.estado.name() == 'CANCELADO'}" class="px-3 py-1 bg-gray-100 text-gray-500 rounded-full text-[10px] font-bold uppercase tracking-wider">Cancelado</span>
                    </div>
                    <p class="text-xl text-apple-secondary" th:text="${sol.motivoViaje}">Motivo de la comisión</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-bold text-apple-secondary uppercase tracking-widest mb-1">Fecha de Solicitud</p>
                    <p class="text-lg font-medium" th:text="${sol.fechaSolicitud}">01/01/2024</p>
                </div>
            </div>

            <!-- Grid de Información -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Solicitante -->
                <div class="bg-white p-6 rounded-[28px] border border-gray-100 shadow-sm flex items-center gap-5">
                    <div class="w-14 h-14 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center border border-blue-100">
                        <i data-lucide="user" class="w-7 h-7"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Solicitante</p>
                        <p class="text-lg font-bold text-gray-900" th:text="${sol.empleado.nombres + ' ' + sol.empleado.apellidos}">Nombre</p>
                        <p class="text-[11px] text-gray-500 font-medium" th:text="${sol.empleado.nivel.nombre}">Nivel</p>
                    </div>
                </div>

                <!-- Periodo -->
                <div class="bg-white p-6 rounded-[28px] border border-gray-100 shadow-sm flex items-center gap-5">
                    <div class="w-14 h-14 bg-gray-50 text-gray-400 rounded-2xl flex items-center justify-center border border-gray-100">
                        <i data-lucide="calendar" class="w-7 h-7"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Periodo de Viaje</p>
                        <p class="text-lg font-bold text-gray-900" th:text="${sol.fechaInicio + ' — ' + (sol.fechaFin ?: 'Pendiente')}">Fechas</p>
                        <p class="text-[11px] text-gray-500 font-medium" th:text="${sol.fechaInicio != null ? 'Comisión Programada' : 'Fecha por confirmar'}">Estado</p>
                    </div>
                </div>
            </div>

            <!-- Presupuesto Autorizado  -->
            <div class="mb-12 animate-in fade-in slide-in-from-bottom-4 duration-700">
                <div class="bg-black rounded-[28px] p-8 text-white shadow-2xl shadow-gray-200/50">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-10">
                        <div class="flex-1">
                            <p class="text-gray-400 text-[10px] uppercase tracking-[0.15em] font-bold mb-1">Presupuesto Total</p>
                            <h2 class="text-5xl font-bold tracking-tight" th:text="${'S/ ' + #numbers.formatDecimal(sol.montoTotal, 1, 'COMMA', 2, 'POINT')}">S/ 0.00</h2>
                        </div>
                        
                        <div class="flex gap-8 border-l border-white/10 pl-8 overflow-hidden">
                            <div>
                                <p class="text-gray-400 text-[10px] uppercase tracking-widest font-bold mb-0.5">Días</p>
                                <p class="text-xl font-semibold text-white" th:text="${sol.itinerarios.size() > 0 ? (sol.itinerarios[sol.itinerarios.size()-1].noches + 1) : 0}">0</p>
                            </div>
                            <div class="px-8 border-l border-white/10">
                                <p class="text-gray-400 text-[10px] uppercase tracking-widest font-bold mb-0.5">Retorno</p>
                                <p class="text-xl font-semibold text-white whitespace-nowrap" th:text="${sol.fechaFin ?: '—'}">01/01</p>
                            </div>
                            <div class="pl-8 border-l border-white/10">
                                <p class="text-gray-400 text-[10px] uppercase tracking-widest font-bold mb-0.5">Empresa</p>
                                <p class="text-xl font-semibold text-white tracking-tight whitespace-nowrap">ISS Corp</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detalles del Itinerario (Visual Car Route) -->
            <div class="mb-12">
                <h3 class="text-xl font-bold mb-8 flex items-center gap-3">
                    <i data-lucide="map-pin" class="w-6 h-6 text-blue-600"></i>
                    Hoja de Ruta e Itinerario
                </h3>
                
                <div class="space-y-6 relative before:absolute before:left-[21px] before:top-4 before:bottom-4 before:w-0.5 before:bg-gray-200 ml-2">
                    <div th:each="iti : ${sol.itinerarios}" class="tramo-row relative ml-12 group">
                        <!-- Car Marker -->
                        <div class="absolute -left-[53px] top-4 w-10 h-10 bg-white border border-gray-100 rounded-xl flex items-center justify-center shadow-sm z-10 transition-all group-hover:border-blue-500 group-hover:shadow-md">
                            <i data-lucide="car" class="w-5 h-5 text-gray-400 group-hover:text-blue-600 transition-colors"></i>
                        </div>
                        
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-all duration-300">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.2em] mb-2" th:text="${iti.zonaDestino.nombre}">Zona</p>
                                    <h4 class="text-xl font-bold text-gray-900" th:text="${iti.ciudadEspecifica}">Ciudad</h4>
                                </div>
                                <div class="px-5 py-2 bg-gray-50/50 rounded-[18px] text-center border border-gray-100">
                                    <p class="text-[10px] font-bold text-gray-400 uppercase mb-0.5">Noches</p>
                                    <p class="text-lg font-bold text-blue-600" th:text="${iti.noches}">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
         

            <!-- Sección de Rechazo si existe -->
            <div th:if="${sol.estado.name() == 'RECHAZADO'}" class="bg-red-50 border border-red-100 p-8 rounded-[28px] mb-10">
                <div class="flex gap-4">
                    <div class="w-12 h-12 bg-white text-red-500 rounded-2xl flex items-center justify-center shadow-sm">
                        <i data-lucide="alert-circle" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h4 class="text-red-600 font-bold mb-1">Motivo del Rechazo</h4>
                        <p class="text-red-500/80 leading-relaxed text-sm" th:text="${sol.comentarioRechazo ?: 'No se especificó un motivo.'}">Comentario</p>
                    </div>
                </div>
            </div>

            <!-- Sección de Cancelación si existe -->
            <div th:if="${sol.estado.name() == 'CANCELADO'}" class="bg-gray-100 border border-gray-200 p-8 rounded-[28px] mb-10">
                <div class="flex gap-4">
                    <div class="w-12 h-12 bg-white text-gray-500 rounded-2xl flex items-center justify-center shadow-sm">
                        <i data-lucide="x-circle" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h4 class="text-gray-900 font-bold mb-1">Solicitud Cancelada</h4>
                        <p class="text-gray-500 leading-relaxed text-sm">Esta solicitud fue cancelada voluntariamente por el usuario y no será procesada.</p>
                    </div>
                </div>
            </div>

            <!-- Sección de Rendido -->
            <div th:if="${sol.estado.name() == 'RENDIDO'}" class="bg-blue-50 border border-blue-100 p-8 rounded-[28px] mb-10">
                <div class="flex gap-4">
                    <div class="w-12 h-12 bg-white text-blue-500 rounded-2xl flex items-center justify-center shadow-sm">
                        <i data-lucide="clock" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h4 class="text-blue-600 font-bold mb-1">Rendición en Proceso de Validación</h4>
                        <p class="text-blue-500/80 leading-relaxed text-sm">Tus comprobantes han sido enviados con éxito. Un administrador revisará la documentación para proceder con la liquidación final.</p>
                    </div>
                </div>
            </div>

            <!-- Sección de Liquidación Final Detallada -->
            <div th:if="${sol.estado.name() == 'LIQUIDADO' && liq != null}" class="mb-10 overflow-hidden">
                <div class="bg-black text-white p-10 rounded-[32px] shadow-2xl relative overflow-hidden">
                    <!-- Decoración de fondo -->
                    <div class="absolute top-0 right-0 w-64 h-64 bg-green-500/10 rounded-full -mr-32 -mt-32 blur-3xl"></div>
                    
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-8">
                            <div class="w-12 h-12 bg-green-500/20 rounded-2xl flex items-center justify-center">
                                <i data-lucide="calculator" class="w-6 h-6 text-green-400"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold tracking-tight">Liquidación Final</h3>
                                <p class="text-gray-400 text-sm">Resumen financiero del viaje</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 p-8 bg-white/5 rounded-[24px] border border-white/10 mb-8">
                            <div>
                                <p class="text-[11px] text-gray-400 uppercase font-bold tracking-widest mb-2">Asignado</p>
                                <p class="text-2xl font-bold" th:text="${'S/ ' + #numbers.formatDecimal(liq.montoAsignado, 1, 2)}">S/ 0.00</p>
                            </div>
                            <div>
                                <p class="text-[11px] text-gray-400 uppercase font-bold tracking-widest mb-2">Validado</p>
                                <p class="text-2xl font-bold text-green-400" th:text="${'S/ ' + #numbers.formatDecimal(liq.montoRendidoValidado, 1, 2)}">S/ 0.00</p>
                            </div>
                            <div class="md:border-l md:border-white/10 md:pl-8">
                                <p class="text-[11px] text-gray-400 uppercase font-bold tracking-widest mb-2">Estado Cierre</p>
                                <span class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-[10px] font-bold uppercase" th:text="${liq.estadoCierre}">CERRADO</span>
                            </div>
                        </div>

                        <!-- Panel de Acción   -->
                        <div th:if="${liq.saldoAfavorEmpresa > 0}" class="flex items-start gap-4 p-6 bg-red-500/10 border border-red-500/20 rounded-[20px]">
                            <i data-lucide="alert-triangle" class="w-6 h-6 text-red-400 mt-1"></i>
                            <div>
                                <p class="text-red-400 font-bold mb-1 uppercase text-[10px] tracking-widest">Saldo a favor de la Empresa</p>
                                <p class="text-xl font-bold mb-2" th:text="${'S/ ' + #numbers.formatDecimal(liq.saldoAfavorEmpresa, 1, 2)}">S/ 0.00</p>
                                <p class="text-gray-400 text-xs">Por favor, acércate a Tesorería o realiza la devolución por los canales oficiales indicando el ID de esta solicitud.</p>
                            </div>
                        </div>

                        <div th:if="${liq.saldoAfavorEmpleado > 0}" class="flex items-start gap-4 p-6 bg-blue-500/10 border border-blue-500/20 rounded-[20px]">
                            <i data-lucide="info" class="w-6 h-6 text-blue-400 mt-1"></i>
                            <div>
                                <p class="text-blue-400 font-bold mb-1 uppercase text-[10px] tracking-widest">Saldo a favor del Empleado</p>
                                <p class="text-xl font-bold mb-2" th:text="${'S/ ' + #numbers.formatDecimal(liq.saldoAfavorEmpleado, 1, 2)}">S/ 0.00</p>
                                <p class="text-gray-400 text-xs">Se procederá con el reembolso de este excedente en la siguiente planilla o mediante transferencia directa.</p>
                            </div>
                        </div>

                        <div th:if="${liq.saldoAfavorEmpresa == 0 && liq.saldoAfavorEmpleado == 0}" class="flex items-start gap-4 p-6 bg-green-500/10 border border-green-500/20 rounded-[20px]">
                            <i data-lucide="check" class="w-6 h-6 text-green-400 mt-1"></i>
                            <div>
                                <p class="text-green-400 font-bold mb-1 uppercase text-[10px] tracking-widest">Cuentas Claras</p>
                                <p class="text-xl font-bold mb-2">S/ 0.00 de saldo pendiente</p>
                                <p class="text-gray-400 text-xs">El monto gastado coincide exactamente con el presupuesto asignado. No se requieren más acciones.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Acciones Finales -->
            <div class="flex justify-between items-center bg-white p-6 rounded-[28px] border border-apple-border">
                <div class="flex items-center gap-2 text-apple-secondary text-xs italic">
                    <i data-lucide="info" class="w-4 h-4"></i>
                    <span th:text="${'Creado por ' + sol.userCrea + ' el ' + sol.fechaCrea}">Auditoria</span>
                </div>
                <div class="flex gap-4 items-center">
                    <!-- Botón Cancelar   -->
                    <form th:if="${sol.estado.name() == 'BORRADOR' || sol.estado.name() == 'PENDIENTE'}" 
                          th:action="@{'/solicitudes/cancelar/' + ${sol.id}}" method="post"
                          onsubmit="return confirm('¿Estás seguro de que deseas cancelar esta solicitud?');">
                        <button type="submit" class="px-6 py-3 text-red-500 font-bold text-sm hover:bg-red-50 rounded-2xl transition-all">
                            Cancelar Solicitud
                        </button>
                    </form>

                    <!-- Botón Enviar   -->
                    <form th:if="${sol.estado.name() == 'BORRADOR'}" th:action="@{'/solicitudes/enviar/' + ${sol.id}}" method="post">
                        <button type="submit" class="px-8 py-3 bg-black text-white font-bold rounded-2xl hover:bg-gray-800 transition-all shadow-lg flex items-center gap-2">
                            Enviar Solicitud
                            <i data-lucide="arrow-right" class="w-4 h-4 text-gray-400"></i>
                        </button>
                    </form>

                    <!-- Botón Rendición   -->
                    <a th:if="${sol.estado.name() == 'APROBADO'}" 
                       th:href="@{'/rendiciones/solicitud/' + ${sol.id}}"
                       class="px-8 py-3 bg-apple-blue text-white font-bold rounded-2xl hover:opacity-90 transition-all shadow-lg flex items-center gap-2">
                        Iniciar Rendición
                        <i data-lucide="arrow-right" class="w-4 h-4 text-white/70"></i>
                    </a>

                    <!-- Ver Rendición   -->
                    <a th:if="${sol.estado.name() == 'RENDIDO' || sol.estado.name() == 'LIQUIDADO'}" 
                       th:href="@{'/rendiciones/solicitud/' + ${sol.id}}"
                       class="px-8 py-3 bg-white text-apple-blue border border-apple-border font-bold rounded-2xl hover:bg-gray-50 transition-all flex items-center gap-2">
                        Ver Gastos Rendidos
                        <i data-lucide="file-text" class="w-4 h-4 text-apple-blue"></i>
                    </a>
                </div>
            </div>
          </div>
        </div>
    </main>

    <script>lucide.createIcons();</script>
</body>
</html>
