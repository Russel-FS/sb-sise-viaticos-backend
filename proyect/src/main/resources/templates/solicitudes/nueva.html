<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nueva Solicitud - ISS Viáticos</title>

    <!--recursos externos-->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!--gestion de temas -->
    <script>
      (function () {
        const savedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;
        if (savedTheme === "dark" || (!savedTheme && prefersDark)) {
          document.documentElement.classList.add("dark");
        }
      })();
    </script>
    <th:block th:replace="~{fragments/theme :: themeStyles}"></th:block>

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              serif: ['"Instrument Serif"', "serif"],
              sans: [
                "Inter",
                "-apple-system",
                "BlinkMacSystemFont",
                "sans-serif",
              ],
            },
            colors: {
              canvas: {
                light: "#F9F8F6",
                dark: "#0F1115",
              },
              card: {
                light: "#FFFFFF",
                dark: "#1C1E22",
              },
              accent: {
                sage: "#E3ECD2",
                forest: "#2D3B2D",
                clay: "#D4A373",
                sand: "#EFEBE0",
              },
              apple: {
                blue: "#007aff",
              },
            },
            borderRadius: {
              "4xl": "2rem",
              "5xl": "2.5rem",
            },
            boxShadow: {
              premium: "0 20px 40px -12px rgba(0, 0, 0, 0.05)",
              glow: "0 0 20px rgba(0,0,0,0.05)",
            },
          },
        },
      };
    </script>

    <style>
      body {
        background-color: #f9f8f6;
        color: #1a1a1a;
        font-family: "Inter", sans-serif;
        -webkit-font-smoothing: antialiased;
        overflow-x: hidden;
      }
      .dark body {
        background-color: #0f1115;
        color: #f1f1f1;
      }

      h1,
      h2,
      h3,
      .serif-font {
        font-family: "Instrument Serif", serif;
      }

      /* Navegación Flotante Extended (Unified) */
      .nav-island {
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.03);
      }
      .dark .nav-island {
        background: rgba(28, 30, 34, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      /* Bento Grid Cards */
      .bento-card {
        background: white;
        border-radius: 2rem;
        border: 1px solid rgba(0, 0, 0, 0.02);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02),
          0 2px 4px -1px rgba(0, 0, 0, 0.02);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1),
          box-shadow 0.4s ease;
      }
      .dark .bento-card {
        background: #1c1e22;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      /* Inputs */
      .input-premium {
        background: #f9f8f6;
        border: 1px solid transparent;
        transition: all 0.3s ease;
      }
      .dark .input-premium {
        background: #25272b;
        color: white;
      }
      .input-premium:focus {
        background: white;
        border-color: #e5e5e5;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
      }
      .dark .input-premium:focus {
        background: #2d3035;
        border-color: #333;
      }

      /* Animations */
      @keyframes fade-in-up {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-enter {
        animation: fade-in-up 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        opacity: 0;
      }
      .delay-100 {
        animation-delay: 100ms;
      }
      .delay-200 {
        animation-delay: 200ms;
      }

      .select-chevron {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-position: right 1.25rem center;
        background-size: 1rem;
        background-repeat: no-repeat;
        appearance: none;
      }
    </style>
  </head>
  <body
    class="min-h-screen pb-20 selection:bg-accent-sage selection:text-accent-forest"
  >
    <div class="fixed top-6 left-0 right-0 z-50 flex justify-center px-4">
      <nav
        class="nav-island rounded-full px-6 py-3 flex items-center gap-8 animate-enter"
      >
        <a
          href="/"
          class="serif-font text-xl font-medium tracking-tight hover:opacity-70 transition-opacity"
        >
          ISS V
        </a>

        <div
          class="hidden md:flex items-center gap-1 bg-gray-100/50 dark:bg-white/5 rounded-full p-1"
        >
          <a
            href="/solicitudes"
            class="px-4 py-1.5 rounded-full text-xs font-medium bg-white dark:bg-white/10 shadow-sm text-gray-900 dark:text-white"
            >Solicitudes</a
          >
          <th:block th:if="${isAdmin}">
            <a
              href="/admin/aprobaciones"
              class="px-4 py-1.5 rounded-full text-xs font-medium hover:bg-white dark:hover:bg-white/10 hover:shadow-sm transition-all text-gray-700 dark:text-gray-300"
              >Aprobaciones</a
            >
            <a
              href="/admin/validaciones"
              class="px-4 py-1.5 rounded-full text-xs font-medium hover:bg-white dark:hover:bg-white/10 hover:shadow-sm transition-all text-gray-700 dark:text-gray-300"
              >Validaciones</a
            >
            <a
              href="/admin/empleados"
              class="px-4 py-1.5 rounded-full text-xs font-medium hover:bg-white dark:hover:bg-white/10 hover:shadow-sm transition-all text-gray-700 dark:text-gray-300"
              >Empleados</a
            >
            <a
              href="/admin/tarifarios"
              class="px-4 py-1.5 rounded-full text-xs font-medium hover:bg-white dark:hover:bg-white/10 hover:shadow-sm transition-all text-gray-700 dark:text-gray-300"
              >Config</a
            >
          </th:block>
        </div>

        <div class="flex items-center gap-4">
          <div
            class="flex items-center gap-3 pl-4 border-l border-gray-200 dark:border-white/10"
          >
            <button
              onclick="toggleTheme()"
              class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-100 dark:hover:bg-white/10 transition-colors"
            >
              <i
                data-lucide="sun"
                class="w-3 h-3 text-gray-500 hidden dark:block"
              ></i>
              <i
                data-lucide="moon"
                class="w-3 h-3 text-gray-500 block dark:hidden"
              ></i>
            </button>
            <form th:action="@{/logout}" method="post">
              <button
                type="submit"
                class="w-8 h-8 rounded-full bg-gray-900 text-white dark:bg-white dark:text-black flex items-center justify-center hover:scale-105 transition-transform"
                title="Salir"
              >
                <i data-lucide="log-out" class="w-3 h-3"></i>
              </button>
            </form>
          </div>
        </div>
      </nav>
    </div>

    <main class="max-w-[1000px] mx-auto px-6 pt-32">
      <!-- Header -->
      <header class="mb-12 text-center animate-enter delay-100">
        <h1 class="text-5xl md:text-6xl mb-4 text-gray-900 dark:text-white">
          Planificación de Viaje
        </h1>
        <p
          class="text-lg text-gray-500 dark:text-gray-400 max-w-xl mx-auto font-light"
        >
          Configura tu comisión de servicio. Calcularemos los costos
          automáticamente.
        </p>
      </header>

      <form
        action="/solicitudes/nueva"
        method="post"
        class="space-y-8 animate-enter delay-200"
      >
        <!-- informacion del viaje -->
        <div class="bento-card p-8 md:p-12 relative overflow-hidden">
          <div
            class="absolute top-0 right-0 w-96 h-96 bg-accent-sage/20 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none"
          ></div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-10 relative z-10">
            <div class="col-span-1 md:col-span-2">
              <h2
                class="text-2xl font-serif mb-6 flex items-center gap-3 dark:text-white"
              >
                <span
                  class="w-8 h-8 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-sm font-sans font-bold"
                  >1</span
                >
                Datos Generales
              </h2>
            </div>

            <div class="col-span-1 md:col-span-2">
              <label
                class="block text-xs font-bold uppercase tracking-widest text-gray-500 mb-2 ml-4"
                >Motivo del Viaje</label
              >
              <input
                type="text"
                name="motivoViaje"
                required
                placeholder="Ej: Supervisión de obras en Sede Norte"
                class="w-full px-6 py-4 rounded-2xl text-lg font-medium input-premium outline-none placeholder:text-gray-400 dark:placeholder:text-gray-600"
              />
            </div>

            <div class="col-span-1">
              <label
                class="block text-xs font-bold uppercase tracking-widest text-gray-500 mb-2 ml-4"
                >Fecha de Salida</label
              >
              <div class="relative">
                <input
                  type="date"
                  id="fechaInicio"
                  name="fechaInicio"
                  required
                  onchange="updateEstimation()"
                  class="w-full px-6 py-4 rounded-2xl text-lg font-medium input-premium outline-none text-gray-700 dark:text-gray-200"
                />
                <i
                  data-lucide="calendar"
                  class="absolute right-6 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none"
                ></i>
              </div>
            </div>

            <div class="col-span-1 flex items-center">
              <div
                class="pl-4 border-l-2 border-accent-sage/50 dark:border-white/10"
              >
                <p
                  class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1"
                >
                  Retorno Estimado
                </p>
                <p
                  id="fechaRetornoDisplay"
                  class="text-xl font-serif text-gray-900 dark:text-white"
                >
                  --/--/----
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- itinerario-->
        <div class="bento-card p-8 md:p-12">
          <div class="flex items-center justify-between mb-8">
            <h2
              class="text-2xl font-serif flex items-center gap-3 dark:text-white"
            >
              <span
                class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm font-sans font-bold"
                >2</span
              >
              Itinerario
            </h2>
            <button
              type="button"
              onclick="agregarTramo()"
              class="group flex items-center gap-2 px-5 py-2.5 bg-gray-900 dark:bg-white text-white dark:text-black rounded-full text-xs font-bold uppercase tracking-wider hover:scale-105 transition-all shadow-lg active:scale-95"
            >
              <i data-lucide="plus" class="w-4 h-4"></i> Añadir Destino
            </button>
          </div>

          <div id="itinerario-container" class="space-y-4">
            <div class="tramo-row relative group">
              <div
                class="absolute left-0 top-0 bottom-0 w-1 bg-gray-100 dark:bg-white/5 rounded-full ml-4 hidden md:block"
              ></div>

              <div
                class="bg-gray-50 dark:bg-white/5 rounded-3xl p-6 md:p-8 hover:bg-white hover:shadow-xl hover:shadow-gray-200/50 dark:hover:bg-white/10 transition-all duration-300 border border-transparent hover:border-gray-100 dark:hover:border-white/5"
              >
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-end">
                  <div class="md:col-span-5">
                    <label
                      class="block text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2 ml-2"
                      >Zona / Región</label
                    >
                    <div class="relative">
                      <select
                        name="idZonas"
                        required
                        onchange="updateEstimation()"
                        class="w-full px-5 py-3 rounded-xl bg-white dark:bg-black/20 text-gray-800 dark:text-gray-200 text-sm font-medium border-0 focus:ring-2 focus:ring-accent-sage outline-none select-chevron cursor-pointer shadow-sm"
                      >
                        <option value="" disabled selected>
                          Seleccionar...
                        </option>
                        <option
                          th:each="zona : ${zonas}"
                          th:value="${zona.id}"
                          th:text="${zona.nombre}"
                        >
                          Zona
                        </option>
                      </select>
                    </div>
                  </div>
                  <div class="md:col-span-4">
                    <label
                      class="block text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2 ml-2"
                      >Ciudad</label
                    >
                    <input
                      type="text"
                      name="ciudades"
                      required
                      placeholder="Ej: Arequipa"
                      class="w-full px-5 py-3 rounded-xl bg-white dark:bg-black/20 text-gray-800 dark:text-gray-200 text-sm font-medium border-0 focus:ring-2 focus:ring-accent-sage outline-none shadow-sm placeholder:text-gray-400"
                    />
                  </div>
                  <div class="md:col-span-3">
                    <label
                      class="block text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2 ml-2"
                      >Noches</label
                    >
                    <input
                      type="number"
                      name="noches"
                      required
                      min="1"
                      value="1"
                      onchange="updateEstimation()"
                      class="w-full px-5 py-3 rounded-xl bg-white dark:bg-black/20 text-gray-800 dark:text-gray-200 text-sm font-bold border-0 focus:ring-2 focus:ring-accent-sage outline-none shadow-sm"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <p
            class="mt-6 text-center text-xs text-gray-400 flex items-center justify-center gap-2"
          >
            <i data-lucide="info" class="w-3 h-3"></i>
            Los viáticos se calculan basados en la tarifa nocturna de cada zona.
          </p>
        </div>

        <!-- tarifa estimada -->
        <div id="estimacionCard" class="hidden animate-enter">
          <div
            class="bento-card bg-gray-900 text-white p-10 flex flex-col md:flex-row items-center justify-between gap-8 relative overflow-hidden dark:border-white/10"
          >
            <!-- Abstract Shapes -->
            <div
              class="absolute top-0 right-0 w-64 h-64 bg-accent-sage/20 rounded-full blur-[80px] pointer-events-none mix-blend-overlay"
            ></div>

            <div class="relative z-10 text-center md:text-left">
              <p
                class="text-gray-400 text-[10px] font-bold uppercase tracking-[0.25em] mb-2"
              >
                Total Estimado
              </p>
              <h3
                class="text-6xl font-serif tracking-tight"
                id="montoTotalDisplay"
              >
                S/ 0.00
              </h3>
              <div
                class="flex items-center gap-4 mt-4 justify-center md:justify-start text-sm text-gray-400"
              >
                <span id="diasDisplay">0 días</span>
                <span class="w-1 h-1 bg-gray-600 rounded-full"></span>
                <span id="finalRetornoDisplay">Retorno: --</span>
              </div>
            </div>

            <div class="relative z-10 w-full md:w-auto">
              <button
                type="submit"
                class="w-full md:w-auto px-10 py-5 bg-white text-black rounded-full font-bold text-lg hover:scale-105 transition-transform shadow-[0_0_40px_-10px_rgba(255,255,255,0.3)] flex items-center justify-center gap-3 active:scale-95"
              >
                Confirmar Solicitud
                <i data-lucide="arrow-right" class="w-5 h-5"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- boton de continuar -->
        <div id="defaultSubmit" class="flex justify-end pt-4">
          <button
            type="submit"
            class="px-10 py-4 bg-gray-900 dark:bg-white text-white dark:text-black rounded-full font-bold hover:opacity-90 transition-opacity shadow-xl"
          >
            Continuar
          </button>
        </div>
      </form>
    </main>

    <!--plantilla para los tramos -->
    <template id="tramo-template">
      <div
        class="tramo-row relative group animate-in slide-in-from-bottom-2 fade-in duration-300"
      >
        <div
          class="absolute left-0 top-0 bottom-0 w-1 bg-gray-100 dark:bg-white/5 rounded-full ml-4 hidden md:block"
        ></div>

        <button
          type="button"
          onclick="this.closest('.tramo-row').remove(); updateEstimation();"
          class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg transform scale-0 group-hover:scale-100 transition-transform z-20"
        >
          <i data-lucide="x" class="w-3 h-3"></i>
        </button>

        <div
          class="bg-gray-50 dark:bg-white/5 rounded-3xl p-6 md:p-8 hover:bg-white hover:shadow-xl hover:shadow-gray-200/50 dark:hover:bg-white/10 transition-all duration-300 border border-transparent hover:border-gray-100 dark:hover:border-white/5 mt-4"
        >
          <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-end">
            <div class="md:col-span-5">
              <label
                class="block text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2 ml-2"
                >Zona / Región</label
              >
              <div class="relative">
                <select
                  name="idZonas"
                  required
                  onchange="updateEstimation()"
                  class="w-full px-5 py-3 rounded-xl bg-white dark:bg-black/20 text-gray-800 dark:text-gray-200 text-sm font-medium border-0 focus:ring-2 focus:ring-accent-sage outline-none select-chevron cursor-pointer shadow-sm"
                >
                  <option value="" disabled selected>Seleccionar...</option>
                  <option
                    th:each="zona : ${zonas}"
                    th:value="${zona.id}"
                    th:text="${zona.nombre}"
                  >
                    Zona
                  </option>
                </select>
              </div>
            </div>
            <div class="md:col-span-4">
              <label
                class="block text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2 ml-2"
                >Ciudad</label
              >
              <input
                type="text"
                name="ciudades"
                required
                placeholder="Ej: Arequipa"
                class="w-full px-5 py-3 rounded-xl bg-white dark:bg-black/20 text-gray-800 dark:text-gray-200 text-sm font-medium border-0 focus:ring-2 focus:ring-accent-sage outline-none shadow-sm placeholder:text-gray-400"
              />
            </div>
            <div class="md:col-span-3">
              <label
                class="block text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2 ml-2"
                >Noches</label
              >
              <input
                type="number"
                name="noches"
                required
                min="1"
                value="1"
                onchange="updateEstimation()"
                class="w-full px-5 py-3 rounded-xl bg-white dark:bg-black/20 text-gray-800 dark:text-gray-200 text-sm font-bold border-0 focus:ring-2 focus:ring-accent-sage outline-none shadow-sm"
              />
            </div>
          </div>
        </div>
      </div>
    </template>

    <script th:inline="javascript">
      lucide.createIcons();

      const container = document.getElementById("itinerario-container");
      const template = document.getElementById("tramo-template");
      const estimacionCard = document.getElementById("estimacionCard");
      const defaultSubmit = document.getElementById("defaultSubmit");
      const montoTotalDisplay = document.getElementById("montoTotalDisplay");
      const diasDisplay = document.getElementById("diasDisplay");
      const fechaRetornoDisplay = document.getElementById(
        "fechaRetornoDisplay"
      );
      const finalRetornoDisplay = document.getElementById(
        "finalRetornoDisplay"
      );
      const inputFechaInicio = document.getElementById("fechaInicio");

      function agregarTramo() {
        const clone = template.content.cloneNode(true);
        container.appendChild(clone);
        lucide.createIcons();
        updateEstimation();
      }

      async function updateEstimation() {
        const idZonas = Array.from(document.getElementsByName("idZonas")).map(
          (el) => el.value
        );
        const noches = Array.from(document.getElementsByName("noches")).map(
          (el) => parseInt(el.value) || 0
        );
        const fechaInicioVal = inputFechaInicio.value;

        // Calc Date
        if (fechaInicioVal) {
          const totalNoches = noches.reduce((a, b) => a + b, 0);
          const fecha = new Date(fechaInicioVal + "T00:00:00");
          fecha.setDate(fecha.getDate() + totalNoches);

          const formattedDate = fecha.toLocaleDateString("es-PE", {
            day: "numeric",
            month: "long",
          });
          fechaRetornoDisplay.innerText = formattedDate;
          finalRetornoDisplay.innerText = "Retorno: " + formattedDate;
        }

        //montos
        if (idZonas.length > 0 && idZonas.every((z) => z !== "")) {
          try {
            const queryParams = idZonas
              .map((z, i) => `idZonas=${z}&noches=${noches[i]}`)
              .join("&");
            const response = await fetch(
              `/api/solicitudes/estimar?${queryParams}`
            );
            const data = await response.json();

            if (data.montoTotal !== undefined) {
              montoTotalDisplay.innerText = `S/ ${data.montoTotal.toLocaleString(
                "es-PE",
                { minimumFractionDigits: 2 }
              )}`;
              diasDisplay.innerText = `${data.dias} días de viaje`;

              estimacionCard.classList.remove("hidden");
              estimacionCard.classList.add("flex");
              defaultSubmit.classList.add("hidden");
            } else {
              estimacionCard.classList.add("hidden");
              defaultSubmit.classList.remove("hidden");
            }
          } catch (error) {
            console.error("Error calculando estimado:", error);
            estimacionCard.classList.add("hidden");
            defaultSubmit.classList.remove("hidden");
          }
        } else {
          estimacionCard.classList.add("hidden");
          defaultSubmit.classList.remove("hidden");
        }
      }
    </script>
    <th:block th:replace="~{fragments/theme :: themeScript}"></th:block>
  </body>
</html>
