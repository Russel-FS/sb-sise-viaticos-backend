<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resumen - ISS Viáticos</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      (function () {
        const savedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;
        if (savedTheme === "dark" || (!savedTheme && prefersDark)) {
          document.documentElement.classList.add("dark");
        }
      })();
    </script>
    <th:block th:replace="~{fragments/theme :: themeStyles}"></th:block>

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: [
                "Inter",
                "-apple-system",
                "BlinkMacSystemFont",
                "sans-serif",
              ],
            },
            colors: {
              aura: {
                blue: "#0066cc",
                surface: "#ffffff",
                bg: "#f5f5f7",
                text: "#1d1d1f",
                gray: "#86868b",
                border: "rgba(0, 0, 0, 0.08)",
              },
              dark: {
                bg: "#000000",
                surface: "#1c1c1e",
                border: "rgba(255, 255, 255, 0.1)",
              },
            },
            borderRadius: {
              aura: "28px",
            },
          },
        },
      };
    </script>

    <style>
      body {
        background-color: #f5f5f7;
        color: #1d1d1f;
        -webkit-font-smoothing: antialiased;
      }
      .dark body {
        background-color: #000000;
        color: #f5f5f7;
      }

      .aura-card {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 28px;
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
          box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),
          background-color 0.3s ease;
        backface-visibility: hidden;
        transform: translateZ(0);
      }

      .dark .aura-card {
        background: rgba(28, 28, 30, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .aura-card:hover {
        transform: translateY(-2px) translateZ(0);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.04);
      }

      .stat-pill {
        padding: 4px 12px;
        border-radius: 100px;
        font-size: 12px;
        font-weight: 600;
      }

      /* animaciones */
      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade {
        animation: fade-in 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        opacity: 0; /* Previene el parpadeo inicial */
      }

      /* custom scroll */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: content-box;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
      }
    </style>
    <th:block th:replace="~{fragments/nav :: styles}"></th:block>
  </head>
  <body class="min-h-screen pb-20">
    <th:block
      th:replace="~{fragments/nav :: navbar(activeTab='home')}"
    ></th:block>

    <main class="max-w-7xl mx-auto px-6 pt-24 md:pt-32">
      <!-- bienvenido hero -->
      <header class="mb-12 animate-fade">
        <p class="text-[17px] font-semibold text-aura-blue mb-2">Dashboard</p>
        <h1
          class="text-[40px] md:text-[48px] font-bold tracking-tight leading-tight"
        >
          Hola,
          <span
            th:text="${currentUser != null ? currentUser.nombreCompleto.split(' ')[0] : 'Usuario'}"
            >Usuario</span
          >.
        </h1>
        <p class="text-[19px] md:text-[21px] text-aura-gray mt-2 max-w-2xl">
          Esto es lo que está pasando hoy con tus viáticos y comisiones.
        </p>
      </header>

      <!-- grid bento -->
      <div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-12">
        <!-- solicitud nueva -->
        <div
          class="col-span-1 md:col-span-8 aura-card p-10 flex flex-col justify-between relative overflow-hidden group animate-fade"
          style="animation-delay: 0.1s"
        >
          <div class="relative z-10">
            <h3 class="text-[32px] font-bold mb-4">Nueva Solicitud</h3>
            <p
              class="text-[17px] text-aura-gray max-w-sm mb-10 leading-relaxed"
            >
              Inicia una comisión de servicio. Calcularemos los viáticos
              automáticamente según el destino y tu nivel.
            </p>
            <a
              href="/solicitudes/nueva"
              class="inline-flex items-center gap-2 bg-aura-blue text-white px-8 py-4 rounded-[18px] font-semibold text-[17px] hover:bg-blue-600 transition-colors shadow-lg shadow-blue-500/20"
            >
              Comenzar ahora
              <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </a>
          </div>

          <!-- background element -->
          <div
            class="absolute -right-10 -bottom-10 w-64 h-64 bg-aura-blue/5 rounded-full blur-3xl group-hover:bg-aura-blue/10 transition-colors"
          ></div>
          <i
            data-lucide="plane"
            class="absolute right-8 bottom-8 w-32 h-32 text-aura-blue/5 rotate-[-15deg] group-hover:rotate-0 transition-transform duration-700"
          ></i>
        </div>

        <!-- Stat Area: Stacked Cards -->
        <div class="col-span-1 md:col-span-4 flex flex-col gap-6">
          <!-- Stat Card 1: Pendientes -->
          <div
            class="aura-card p-8 flex items-center justify-between animate-fade"
            style="animation-delay: 0.2s"
          >
            <div>
              <p
                class="text-[13px] font-bold uppercase tracking-wider text-orange-500 mb-1"
              >
                En revisión
              </p>
              <div
                class="text-[44px] font-bold leading-none"
                th:text="${totalPendientes}"
              >
                0
              </div>
            </div>
            <div
              class="w-14 h-14 rounded-[22px] bg-orange-500/10 flex items-center justify-center text-orange-500"
            >
              <i data-lucide="timer" class="w-7 h-7"></i>
            </div>
          </div>

          <!-- Stat Card 2: Aprobadas -->
          <div
            class="aura-card p-8 flex items-center justify-between animate-fade"
            style="animation-delay: 0.3s"
          >
            <div>
              <p
                class="text-[13px] font-bold uppercase tracking-wider text-green-500 mb-1"
              >
                Aprobadas
              </p>
              <div
                class="text-[44px] font-bold leading-none"
                th:text="${totalAprobados}"
              >
                0
              </div>
            </div>
            <div
              class="w-14 h-14 rounded-[22px] bg-green-500/10 flex items-center justify-center text-green-500"
            >
              <i data-lucide="check-circle-2" class="w-7 h-7"></i>
            </div>
          </div>
        </div>

        <!--  Chart Area -->
        <div
          class="col-span-1 md:col-span-5 aura-card p-8 animate-fade"
          style="animation-delay: 0.4s"
        >
          <div class="flex items-center justify-between mb-8">
            <h3 class="text-[21px] font-bold">Estado Global</h3>
            <div class="stat-pill bg-aura-blue/10 text-aura-blue">
              Histórico
            </div>
          </div>

          <div class="relative flex items-center justify-center h-[240px]">
            <canvas id="statusChart"></canvas>
            <div
              class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"
            >
              <span
                class="text-[32px] font-bold leading-none"
                th:text="${totalPendientes + totalAprobados + totalLiquidados}"
                >0</span
              >
              <span
                class="text-[13px] text-aura-gray font-medium uppercase tracking-widest mt-1"
                >Total</span
              >
            </div>
          </div>

          <div class="mt-8 flex flex-wrap justify-center gap-6">
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-orange-500"></span>
              <span class="text-[13px] font-medium">Pendientes</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-green-500"></span>
              <span class="text-[13px] font-medium">Aprobadas</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-blue-500"></span>
              <span class="text-[13px] font-medium">Liquidadas</span>
            </div>
          </div>
        </div>

        <!-- lista de actividad reciente  -->
        <div
          class="col-span-1 md:col-span-7 aura-card p-8 animate-fade"
          style="animation-delay: 0.5s"
        >
          <div class="flex items-center justify-between mb-8">
            <div>
              <h3 class="text-[21px] font-bold">Recientes</h3>
              <p class="text-[15px] text-aura-gray mt-1">
                Tus últimos movimientos.
              </p>
            </div>
            <a
              href="/solicitudes"
              class="text-aura-blue hover:underline text-[15px] font-semibold"
              >Ver todas</a
            >
          </div>

          <div class="space-y-2">
            <!-- Empty State -->
            <div
              th:if="${#lists.isEmpty(solicitudes)}"
              class="flex flex-col items-center justify-center py-12 text-center"
            >
              <div
                class="w-16 h-16 bg-aura-bg/50 dark:bg-dark-border rounded-full flex items-center justify-center mb-4"
              >
                <i data-lucide="inbox" class="w-8 h-8 text-aura-gray"></i>
              </div>
              <p class="text-aura-gray text-[15px]">Aún no tienes registros.</p>
            </div>

            <!-- Item -->
            <div
              th:each="sol : ${solicitudes}"
              th:data-id="${sol.id}"
              onclick="window.location.href='/solicitudes/' + this.dataset.id"
              class="group flex items-center justify-between p-4 rounded-[20px] hover:bg-aura-bg/50 dark:hover:bg-white/5 transition-all cursor-pointer border border-transparent hover:border-aura-border"
            >
              <div class="flex items-center gap-4">
                <div
                  class="w-12 h-12 rounded-[16px] flex items-center justify-center shadow-sm"
                  th:classappend="${sol.estado.name() == 'PENDIENTE' ? 'bg-orange-500/10 text-orange-500' : 
                                      (sol.estado.name() == 'APROBADO' ? 'bg-green-500/10 text-green-500' : 
                                      (sol.estado.name() == 'LIQUIDADO' ? 'bg-blue-500/10 text-blue-500' : 'bg-aura-gray/10 text-aura-gray'))}"
                >
                  <i
                    th:if="${sol.estado.name() == 'PENDIENTE'}"
                    data-lucide="clock"
                    class="w-6 h-6"
                  ></i>
                  <i
                    th:if="${sol.estado.name() == 'APROBADO'}"
                    data-lucide="check"
                    class="w-6 h-6"
                  ></i>
                  <i
                    th:if="${sol.estado.name() == 'LIQUIDADO'}"
                    data-lucide="shield-check"
                    class="w-6 h-6"
                  ></i>
                  <i
                    th:if="${sol.estado.name() == 'RECHAZADO'}"
                    data-lucide="alert-circle"
                    class="w-6 h-6"
                  ></i>
                  <i
                    th:if="${sol.estado.name() == 'CANCELADO'}"
                    data-lucide="alert-circle"
                    class="w-6 h-6"
                  ></i>
                  <i
                    th:if="${sol.estado.name() == 'BORRADOR'}"
                    data-lucide="alert-circle"
                    class="w-6 h-6"
                  ></i>
                </div>
                <div>
                  <h4
                    class="font-bold text-[17px]"
                    th:text="${sol.motivoViaje}"
                  >
                    Motivo
                  </h4>
                  <p
                    class="text-[13px] text-aura-gray font-medium"
                    th:text="${sol.fechaInicio}"
                  >
                    Fecha
                  </p>
                </div>
              </div>
              <div class="text-right">
                <div
                  class="font-bold text-[17px]"
                  th:text="${'S/ ' + #numbers.formatDecimal(sol.montoTotal, 1, 0)}"
                >
                  S/ 0
                </div>
                <div
                  class="text-[11px] font-bold uppercase tracking-wider mt-1 px-2 py-0.5 rounded-full inline-block"
                  th:classappend="${sol.estado.name() == 'PENDIENTE' ? 'text-orange-500' : 
                                      (sol.estado.name() == 'APROBADO' ? 'text-green-500' : 'text-aura-gray')}"
                  th:text="${sol.estado}"
                >
                  ESTADO
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Widgets -->
        <div
          class="col-span-1 md:col-span-12 mt-4 animate-fade"
          style="animation-delay: 0.6s"
        >
          <h3 class="text-[24px] font-bold mb-6">Explorar</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Feature 1 -->
            <a
              href="/politicas/privacidad"
              class="aura-card p-6 flex items-start gap-4 group"
            >
              <div
                class="w-12 h-12 rounded-[18px] bg-blue-500/10 text-blue-500 flex items-center justify-center shrink-0"
              >
                <i data-lucide="file-text" class="w-6 h-6"></i>
              </div>
              <div>
                <h4
                  class="font-bold text-[17px] group-hover:text-aura-blue transition-colors"
                >
                  Normativa Institucional
                </h4>
                <p class="text-[15px] text-aura-gray mt-1 leading-relaxed">
                  Consulta las reglas de rendición y viáticos actualizadas para
                  2025.
                </p>
              </div>
            </a>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer
      class="py-20 text-center animate-fade"
      style="animation-delay: 0.7s"
    >
      <div
        class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-aura-border bg-aura-surface/50 backdrop-blur-sm"
      >
        <span
          class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.5)]"
        ></span>
        <span
          class="text-[11px] font-bold uppercase tracking-widest text-aura-gray"
          >Sistema Activo</span
        >
      </div>
      <p class="mt-8 text-[13px] text-aura-gray font-medium">
        © 2025 Ingeniería y Servicios del Sur S.A.C.
      </p>
    </footer>

    <!-- Scripts -->
    <script th:inline="javascript">
      lucide.createIcons();

      document.addEventListener("DOMContentLoaded", function () {
        const ctx = document.getElementById("statusChart").getContext("2d");
        const labels = /*[[${chartLabels}]]*/ [];
        const data = /*[[${chartData}]]*/ [];

        const isDark = document.documentElement.classList.contains("dark");
        const colors = ["#f97316", "#22c55e", "#3b82f6", "#8b5cf6"];

        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: colors,
                borderWidth: 0,
                hoverOffset: 12,
                borderRadius: 16,
                spacing: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "82%",
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: isDark ? "#1c1c1e" : "#ffffff",
                titleColor: isDark ? "#ffffff" : "#000000",
                bodyColor: isDark ? "#ffffff" : "#000000",
                padding: 16,
                cornerRadius: 16,
                displayColors: true,
                boxPadding: 6,
                borderColor: "rgba(0,0,0,0.1)",
                borderWidth: 1,
                bodyFont: { family: "Inter", size: 14, weight: "bold" },
              },
            },
          },
        });
      });
    </script>

    <th:block th:replace="~{fragments/theme :: themeScript}"></th:block>
  </body>
</html>
